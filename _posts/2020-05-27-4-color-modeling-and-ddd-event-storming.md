---
layout: post
title: "四色建模法和DDD建模"
description: ""
category: 
tags: []
---
{% include JB/setup %}

如精益需求管理中的洋葱圈一样，技术实现层面也有类似的“洋葱圈”，按外层对内层的决策及影响程度划分，从外向里依次是：产品业务需求，系统架构（包含模型），代码实现。包含模型的系统架构设计服务和取决于业务，而代码实现的方式，质量，工作量和拓展及应对需求变化的返工率受系统架构设计的较大影响。架构设计层面的小偏差到实现层面可能就是灾难。

那么，如何做出好的系统架构？其中重要的一部分是如何做好建模，即如何合适地将业务需求翻译为软件可实现的语言。引用徐昊对建模的描述：“领域建模有很多种方法，对于同样的问题域使用不同的建模手段得到的模型可能也不尽相同。”，与其考虑如何保证建模的正确性，不如是考虑如何为企业业务系统而建出能够支撑企业的运营模型。

本文讨论的两种方法将对系统架构中Context，Container，Component，Code四层都有输入，过程和结果更聚焦在下层，关注业务核心数据。

四色建模和DDD（Event storming部分）是两种现TW流行的两种建模方法。两个不同时间提出和流行的建模方式在建模思想上有着相通之处，也各有特色。

### 四色建模法

个人认为，对用户来说软件提供两种功能，做某种操作，记录这种操作。而需要哪些数据来标记和追溯这些操作，就是建模考虑的事情。

四色建模法是对Peter Coad的Color UML做的进一步应用和延伸，

四色建模法是通过以下几个步骤完成：

   1. 梳理业务流程，寻找要追溯的事件，并列出记录每个事件的“时标对象”（**粉色标识**）。如下图：
<div style="text-align:center"><img src ="/assets/images/四色建模-业务流程图.jpg" style="height:300px;" /></div>

   2. 丰富模型，补充时标对象周围的实体对象：人，地点， 物（party/place/thing）。（**绿色标识**）

   3. 丰富模型，补充角色（role）。（**黄色标识**）

   4. 丰富模型，补充描述信息，如每个概念的定义，包含的属性。（**蓝色标识**）

      最终如下图：

      <div style="text-align:center"><img src ="/assets/images/四色建模-最终模型图.jpg" style="height:300px;" /></div>

### 领域驱动模型设计

如果把DDD event storming分为业务梳理阶段（找事件），建模阶段（找模型），架构设计阶段（划分上下文及领域）三个阶段，中间阶段即为建模。

与四色建模法类似，DDD event storming中也用到不同颜色标识的内容，如下图所示：
<div style="text-align:center"><img src ="/assets/images/DDD-event-storming-legend.png" style="height:300px;" /></div>

DDD event storming得出模型图的过程大致如下：

1. 寻找事件（可得出一些业务语言中的处理对象）

2. 寻找命令和触发者

   此步骤可得出用户流程图，即有触发关系的事件和命令组成的包含角色信息的流程图。此处相对四色建模法给出更多的引导信息，命令执行者可能不只是人（角色）。

3. 寻找聚合

   此步骤为建模的关键阶段。将事件中的处理对象找出，并将业务上关联性强的entity，value object聚合在一起。聚集后的对象，可以让设计者更容易理出大量对象之间的关系。

4. 划分限界上下文和领域

   类似伍斌老师说的“限界纸币建模法”，相对四色建模法，聚合对象让设计者更容易关注在核心领域上。

前三步已经可以得到领域模型图，后面的步骤对对象做进一步的划分，从而得到更高层级的理解和架构图，类似C4模型中的Context和Container。

除此之外，DDD event storming还设计了代表不确定因素的红色标签。更细化方案的落地。

### 如何选择

大家可以看到，四色建模法和领域驱动工作坊中的建模方式基本都是从业务梳理开始，从业务流程中找出对象，补充不同类型的对象和信息，然后得出模型图。思路的类似性缘自技术的一切都是为了服务业务。

同样的，无论是四色建模法还是DDD event storming，对象或模型的产出都需要对业务充分理解，对对象识别有敏感性，并时刻关注数据流，避免漏掉必要的对象。如需要识别出可能有二义性的对象名字，如常说的不同场景下的“商品”不是同一个操作对。可能需要创造出一个业务术语中不存在的中间状态的对象，如常说的同一个阶段的同一个东西可能是不同的对象，业务术语中都是同一个名字，但对应的操作很多不同，需要给中间状态的对象重新起名作为软件中不同的对象。

同样的，

不同的是，如上部分提到，四色建模法更加精炼，也许是在已有用户流程图的基础上，找出不同类型对象及其关系即可。而DDD event storming从梳理业务时即产生并统一化了部分对象的名字和定义。

DDD更容易引导设计者得出尽量多的对象，但聚焦在核心对象上。

四色建模法中有明确的对象定义（包含属性），对识别二义性很有用，写下来的定义更容易统一认识。可以在使用DDD event storming时也记录该信息。

### 小结

如果业务需求流程已经很清晰确定并团队及客户的理解一致，可能四色建模法是较快的方式。DDD event storming相对流程较重，但在梳理业务和统一业务理解上，和高层次（context，container和component）的架构设计上有很大作用。

方法不是万能的，在合适的场景使用合适的方法可以帮助设计者整理思路，让没有唯一答案的架构设计有更多的依据。

### Ref：

[1] 徐昊改编的四色建模法：https://www.infoq.cn/article/xh-four-color-modeling

[2] 仝键的C4模型介绍：https://insights.thoughtworks.cn/c4-model/

[3] 伍斌的从“四色建模法”到“限界纸币建模法”：https://insights.thoughtworks.cn/paper-pen-modeling/

[4] Peter Coad的Color UML：https://en.wikipedia.org/wiki/Object_Modeling_in_Color
